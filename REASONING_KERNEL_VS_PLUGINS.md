# æ¨ç†æ’ä»¶ vs å†…æ ¸æ¨ç†æ¨¡å— - å¯¹æ¯”åˆ†æ

## ğŸ“Š æ ¸å¿ƒåŒºåˆ«æ€»ç»“

| ç»´åº¦ | å†…æ ¸æ¨ç†æ¨¡å— | æ¨ç†æ’ä»¶ |
|------|------------|----------|
| **ä½ç½®** | `apt_model/runtime/decoder/` | `apt_model/console/plugins/reasoning/` |
| **æ¶æ„å±‚é¢** | æ¨¡å‹è¿è¡Œæ—¶ç»„ä»¶ | Console æ’ä»¶ç³»ç»Ÿ |
| **é›†æˆæ–¹å¼** | ç¡¬ç¼–ç åˆ°æ¨¡å‹æ¨ç†æµç¨‹ | å¯æ’æ‹”ã€åŠ¨æ€åŠ è½½ |
| **ä½œç”¨èŒƒå›´** | Token çº§åˆ«æ¨ç†æ§åˆ¶ | æ¨ç†ç­–ç•¥å’Œåå¤„ç† |
| **æ‰§è¡Œæ—¶æœº** | æ¨¡å‹å‰å‘ä¼ æ’­æœŸé—´ | æ¨ç†å‰/å |
| **ä¾èµ–å…³ç³»** | è¢«æ’ä»¶ä¾èµ– | ä¾èµ–å†…æ ¸æ¨ç† |

---

## ğŸ—ï¸ æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åº”ç”¨å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  æ¨ç†æ’ä»¶ (Console Plugins)            â”‚      â”‚
â”‚  â”‚  - Self-Consistency                    â”‚      â”‚
â”‚  â”‚  - Beam Search                         â”‚      â”‚
â”‚  â”‚  - Program-Aided                       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                    â†“ ä¾èµ–                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Console Core (äº‹ä»¶ç³»ç»Ÿ)               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ¨¡å‹å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å†…æ ¸æ¨ç†æ¨¡å— (Runtime Decoder)        â”‚      â”‚
â”‚  â”‚  - ReasoningController                 â”‚      â”‚
â”‚  â”‚  - StructuredReasoner                  â”‚      â”‚
â”‚  â”‚  - ChainOfThoughtReasoner              â”‚      â”‚
â”‚  â”‚  - MultiCriteriaHalting                â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                    â†“ æ“ä½œ                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  æ¨¡å‹å‰å‘ä¼ æ’­                          â”‚      â”‚
â”‚  â”‚  - Hidden States                       â”‚      â”‚
â”‚  â”‚  - Attention                           â”‚      â”‚
â”‚  â”‚  - MoE Routing                         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å†…æ ¸æ¨ç†æ¨¡å— (Runtime Decoder)

### å®šä½
**æ¨¡å‹è¿è¡Œæ—¶çš„æ ¸å¿ƒæ¨ç†å¼•æ“**

### å…³é”®æ–‡ä»¶
- `apt_model/runtime/decoder/reasoning_controller.py`
- `apt_model/runtime/decoder/structured_reasoner.py`
- `apt_model/runtime/decoder/halting.py`

### æ ¸å¿ƒåŠŸèƒ½

#### 1. **ReasoningController**
```python
# Token çº§åˆ«çš„æ¨ç†æ§åˆ¶
h_input â†’ [æ¨ç†æ­¥éª¤1] â†’ [æ¨ç†æ­¥éª¤2] â†’ ... â†’ h_output
          â†“              â†“
       ä¸“å®¶è·¯ç”±      åœæ­¢åˆ¤æ–­
```

**ä½œç”¨**:
- åœ¨ hidden states å±‚é¢è¿›è¡Œè¿­ä»£æ¨ç†
- æ§åˆ¶æ¯ä¸ª token çš„æ¨ç†æ­¥æ•°
- è‡ªé€‚åº”åœæ­¢ï¼ˆKLæ•£åº¦ã€çŠ¶æ€å˜åŒ–ã€ç†µï¼‰
- é¢„ç®—æ§åˆ¶ï¼ˆé€‰æ‹©æ€§æ¨ç†ï¼‰

**ç‰¹ç‚¹**:
- âœ… åµŒå…¥åœ¨æ¨¡å‹å‰å‘ä¼ æ’­ä¸­
- âœ… æ“ä½œ token embeddings
- âœ… ä½¿ç”¨ Vein subspace projection
- âœ… MoE ä¸“å®¶è·¯ç”±

#### 2. **StructuredReasoner**
```python
# å•æ­¥æ¨ç†
h â†’ VeinæŠ•å½± â†’ MoEè·¯ç”± â†’ ä¸“å®¶æ··åˆ â†’ é‡å»º â†’ h_new
```

**ä½œç”¨**:
- ä½ç§©å­ç©ºé—´æ¨ç†ï¼ˆVein subspaceï¼‰
- ä¸“å®¶è·¯ç”±å’Œæ··åˆ
- è®¡ç®—åœæ­¢æ¦‚ç‡

**ç‰¹ç‚¹**:
- âœ… é«˜æ•ˆçš„ä½ç§©è®¡ç®—
- âœ… å¯å­¦ä¹ çš„å‚æ•°
- âœ… æ¢¯åº¦å¯åå‘ä¼ æ’­

#### 3. **è®­ç»ƒé›†æˆ**
```python
# è®­ç»ƒæ—¶çš„æ¨ç†æŸå¤±
loss = cross_entropy(logits, labels) + aux_loss
                                         â†‘
                              ä¸“å®¶è´Ÿè½½å‡è¡¡ã€æ¨ç†æ­¥æ•°æƒ©ç½š
```

---

## ğŸ”Œ æ¨ç†æ’ä»¶ (Console Plugins)

### å®šä½
**æ¨ç†ç­–ç•¥çš„é«˜çº§åŒ…è£…å’Œåå¤„ç†**

### å…³é”®æ–‡ä»¶
- `apt_model/console/plugins/reasoning/self_consistency_plugin.py`
- `apt_model/console/plugins/reasoning/beam_search_plugin.py`
- `apt_model/console/plugins/reasoning/program_aided_plugin.py`

### æ ¸å¿ƒåŠŸèƒ½

#### 1. **Self-Consistency Plugin**
```python
# åºåˆ—çº§åˆ«çš„å¤šè·¯å¾„é‡‡æ ·
é—®é¢˜ â†’ [ç”Ÿæˆè·¯å¾„1] â†’ ç­”æ¡ˆ1
    â†’ [ç”Ÿæˆè·¯å¾„2] â†’ ç­”æ¡ˆ2    â†’ æŠ•ç¥¨ â†’ æœ€ç»ˆç­”æ¡ˆ
    â†’ [ç”Ÿæˆè·¯å¾„3] â†’ ç­”æ¡ˆ3
```

**ä½œç”¨**:
- è°ƒç”¨æ¨¡å‹ç”Ÿæˆå¤šä¸ªå®Œæ•´æ¨ç†åºåˆ—
- ä»åºåˆ—ä¸­æå–ç­”æ¡ˆ
- å¤šæ•°æŠ•ç¥¨é€‰æ‹©æœ€ä¸€è‡´ç­”æ¡ˆ

**ç‰¹ç‚¹**:
- âœ… åºåˆ—çº§åˆ«æ“ä½œï¼ˆä¸æ˜¯ token çº§åˆ«ï¼‰
- âœ… å¤šæ¬¡è°ƒç”¨æ¨¡å‹
- âœ… åå¤„ç†ç­”æ¡ˆæå–å’ŒæŠ•ç¥¨
- âœ… ä¸æ”¹å˜æ¨¡å‹å†…éƒ¨çŠ¶æ€

#### 2. **Beam Search Plugin**
```python
# ç»´æŠ¤å¤šä¸ªå€™é€‰åºåˆ—
åˆå§‹ â†’ [æ‰©å±•] â†’ Top-kå€™é€‰ â†’ [æ‰©å±•] â†’ Top-kå€™é€‰ â†’ æœ€ä½³åºåˆ—
```

**ä½œç”¨**:
- åœ¨è§£ç å±‚é¢æ§åˆ¶ç”Ÿæˆç­–ç•¥
- ç»´æŠ¤å€™é€‰åºåˆ—æŸ
- è·¯å¾„è¯„åˆ†å’Œå‰ªæ

**ç‰¹ç‚¹**:
- âœ… è§£ç ç­–ç•¥ï¼ˆä¸æ˜¯æ¨ç†æœºåˆ¶ï¼‰
- âœ… æ“ä½œå®Œæ•´åºåˆ—
- âœ… å¯èƒ½è°ƒç”¨å†…æ ¸æ¨ç†ä½œä¸ºå•æ­¥ç”Ÿæˆ

#### 3. **Program-Aided Plugin**
```python
# ä»£ç ç”Ÿæˆå’Œæ‰§è¡Œ
é—®é¢˜ â†’ [ç”ŸæˆPythonä»£ç ] â†’ [æ²™ç®±æ‰§è¡Œ] â†’ ç»“æœ
```

**ä½œç”¨**:
- ç”Ÿæˆå¯æ‰§è¡Œä»£ç 
- å¤–éƒ¨æ‰§è¡Œè·å–ç»“æœ
- ä¸ç¬¦å·è®¡ç®—ç³»ç»Ÿé›†æˆ

**ç‰¹ç‚¹**:
- âœ… å¤–éƒ¨å·¥å…·è°ƒç”¨
- âœ… ä¸ä¾èµ– hidden states
- âœ… ç¡®å®šæ€§è®¡ç®—

---

## ğŸ”— åä½œå…³ç³»

### å…¸å‹å·¥ä½œæµç¨‹

```python
# ç”¨æˆ·è¯·æ±‚
question = "What is 15% of 80?"

# 1. æ¨ç†æ’ä»¶ï¼šSelf-Consistency å¯åŠ¨
plugin.on_decode() {
    for path in range(5):  # ç”Ÿæˆ5æ¡è·¯å¾„

        # 2. è°ƒç”¨æ¨¡å‹ç”Ÿæˆ
        output = model.generate(
            input_ids,
            # 3. å†…æ ¸æ¨ç†ï¼šåœ¨æ¨¡å‹å†…éƒ¨å·¥ä½œ
            # ReasoningController æ§åˆ¶æ¯ä¸ª token çš„æ¨ç†
            # StructuredReasoner æ‰§è¡Œ Vein subspace æ¨ç†
            # MultiCriteriaHalting å†³å®šä½•æ—¶åœæ­¢
        )

        paths.append(output)

    # 4. æ¨ç†æ’ä»¶ï¼šåå¤„ç†
    answers = [extract_answer(p) for p in paths]
    final_answer = vote(answers)  # æŠ•ç¥¨
}
```

### ä¾èµ–å…³ç³»

```
æ¨ç†æ’ä»¶ï¼ˆåº”ç”¨å±‚ï¼‰
    â†“ è°ƒç”¨
æ¨¡å‹ç”Ÿæˆ API
    â†“ ä½¿ç”¨
å†…æ ¸æ¨ç†æ¨¡å—ï¼ˆè¿è¡Œæ—¶ï¼‰
    â†“ æ“ä½œ
Hidden States / Embeddings
```

---

## ğŸ“‹ åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | å†…æ ¸æ¨ç† | æ¨ç†æ’ä»¶ |
|------|---------|----------|
| **å¤šæ­¥æ¨ç†** | âœ… Tokençº§è¿­ä»£ | âœ… åºåˆ—çº§å¤šæ¬¡ç”Ÿæˆ |
| **è‡ªé€‚åº”åœæ­¢** | âœ… KL/ç†µ/çŠ¶æ€å˜åŒ– | âŒ å›ºå®šè·¯å¾„æ•° |
| **é¢„ç®—æ§åˆ¶** | âœ… Tokençº§é€‰æ‹© | âŒ |
| **ä¸“å®¶è·¯ç”±** | âœ… MoE routing | âŒ |
| **è‡ªæ´½æ€§** | âŒ | âœ… å¤šè·¯å¾„æŠ•ç¥¨ |
| **æŸæœç´¢** | âŒ | âœ… Beam search |
| **ä»£ç æ‰§è¡Œ** | âŒ | âœ… PAL/PoT |
| **å‚æ•°å­¦ä¹ ** | âœ… å¯è®­ç»ƒ | âŒ åå¤„ç† |
| **æ¢¯åº¦åä¼ ** | âœ… | âŒ |
| **å¯æ’æ‹”** | âŒ ç¡¬ç¼–ç  | âœ… åŠ¨æ€åŠ è½½ |

---

## ğŸ¨ ä½¿ç”¨åœºæ™¯

### å†…æ ¸æ¨ç†æ¨¡å—
**ä½•æ—¶ä½¿ç”¨**:
- è®­ç»ƒæ¨ç†å¢å¼ºæ¨¡å‹
- éœ€è¦ä½ç§©é«˜æ•ˆæ¨ç†
- Token çº§åˆ«çš„è‡ªé€‚åº”æ¨ç†
- é¢„ç®—çº¦æŸçš„æ¨ç†

**ä¾‹å­**:
```python
# è®­ç»ƒæ—¶
reasoning_controller = ReasoningController(vein_projector, max_steps=6)
h_reasoned, info = reasoning_controller(hidden_states, lm_head)
loss = compute_loss(h_reasoned, labels)
loss.backward()  # æ¢¯åº¦åä¼ åˆ°æ¨ç†æ¨¡å—
```

### æ¨ç†æ’ä»¶
**ä½•æ—¶ä½¿ç”¨**:
- æ¨ç†æ—¶éœ€è¦å¤šæ ·æ€§
- éœ€è¦åå¤„ç†å’ŒæŠ•ç¥¨
- ç»“åˆå¤–éƒ¨å·¥å…·ï¼ˆä»£ç æ‰§è¡Œï¼‰
- ä¸ä¿®æ”¹æ¨¡å‹å‚æ•°

**ä¾‹å­**:
```python
# æ¨ç†æ—¶
console.register_plugin(SelfConsistencyPlugin(num_paths=5))
context = console.emit_event('on_decode',
    context_data={'use_self_consistency': True})
answer = context.data['self_consistency_result']['answer']
```

---

## ğŸ’¡ å…³é”®æ´å¯Ÿ

### 1. **äº’è¡¥è€Œéæ›¿ä»£**
- å†…æ ¸æ¨ç† = åŸºç¡€èƒ½åŠ›ï¼ˆå¦‚ä½•æ¨ç†ï¼‰
- æ¨ç†æ’ä»¶ = ç­–ç•¥å¢å¼ºï¼ˆå¦‚ä½•ä½¿ç”¨æ¨ç†ï¼‰

### 2. **ä¸åŒæŠ½è±¡å±‚æ¬¡**
- å†…æ ¸ï¼šToken embedding ç©ºé—´
- æ’ä»¶ï¼šå®Œæ•´åºåˆ—ç©ºé—´

### 3. **è®­ç»ƒ vs æ¨ç†**
- å†…æ ¸ï¼šè®­ç»ƒå’Œæ¨ç†éƒ½ä½¿ç”¨
- æ’ä»¶ï¼šä¸»è¦ç”¨äºæ¨ç†

### 4. **æ•ˆç‡æƒè¡¡**
- å†…æ ¸ï¼šä¸€æ¬¡å‰å‘ä¼ æ’­ï¼Œå¤šæ­¥å†…éƒ¨æ¨ç†ï¼ˆé«˜æ•ˆï¼‰
- æ’ä»¶ï¼šå¤šæ¬¡å‰å‘ä¼ æ’­ï¼Œåå¤„ç†èšåˆï¼ˆçµæ´»ä½†æ…¢ï¼‰

---

## ğŸš€ æœ€ä½³å®è·µ

### ç»„åˆä½¿ç”¨
```python
# 1. è®­ç»ƒé˜¶æ®µï¼šä½¿ç”¨å†…æ ¸æ¨ç†
model = APTModel(
    reasoning_controller=ReasoningController(...)
)
train(model, reasoning_dataset)

# 2. æ¨ç†é˜¶æ®µï¼šå åŠ æ¨ç†æ’ä»¶
console = ConsoleCore()
console.register_plugin(SelfConsistencyPlugin())  # å¤šè·¯å¾„
# å†…æ ¸æ¨ç†åœ¨æ¯æ¡è·¯å¾„å†…éƒ¨å·¥ä½œ
# æ’ä»¶åœ¨å¤šæ¡è·¯å¾„ä¹‹é—´èšåˆ
```

### é€‰æ‹©æŒ‡å—
- **éœ€è¦è®­ç»ƒï¼Ÿ** â†’ ä½¿ç”¨å†…æ ¸æ¨ç†
- **éœ€è¦å¤šæ ·æ€§ï¼Ÿ** â†’ ä½¿ç”¨ Self-Consistency æ’ä»¶
- **éœ€è¦æœç´¢ï¼Ÿ** â†’ ä½¿ç”¨ Beam Search æ’ä»¶
- **éœ€è¦å·¥å…·ï¼Ÿ** â†’ ä½¿ç”¨ Program-Aided æ’ä»¶
- **éœ€è¦é«˜æ•ˆï¼Ÿ** â†’ ä½¿ç”¨å†…æ ¸çš„ BudgetedReasoningController

---

**æ€»ç»“**: å†…æ ¸æ¨ç†æ˜¯"å¼•æ“"ï¼Œæ’ä»¶æ˜¯"é©¾é©¶ç­–ç•¥"ã€‚å†…æ ¸æä¾›åŸºç¡€æ¨ç†èƒ½åŠ›ï¼Œæ’ä»¶åˆ©ç”¨è¿™äº›èƒ½åŠ›å®ç°é«˜çº§æ¨ç†ç­–ç•¥ã€‚
