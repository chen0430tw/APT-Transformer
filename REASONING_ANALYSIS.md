# APT æ¨ç†æ¨¡å—åˆ†ææŠ¥å‘Š

ç”Ÿæˆæ—¶é—´: 2025-10-26
åˆ†æ”¯: `claude/review-main-branch-011CUUjQ53AyMxCPDEzqFhoC`

---

## ğŸ“Š ç°æœ‰æ¨ç†æ¨¡å—æ¸…å•

### 1. æ ¸å¿ƒæ¨ç†æ§åˆ¶å™¨

#### âœ… ReasoningController
**æ–‡ä»¶**: `apt_model/runtime/decoder/reasoning_controller.py:17-184`

**åŠŸèƒ½**:
- å¤šæ­¥è¿­ä»£æ¨ç†
- è‡ªé€‚åº”åœæ­¢æœºåˆ¶ï¼ˆåŸºäº KL æ•£åº¦ã€çŠ¶æ€å˜åŒ–ã€ç†µå˜åŒ–ã€learned haltï¼‰
- Patience æ§åˆ¶ï¼ˆè¿ç»­æœªæ”¶æ•›æ­¥æ•°ï¼‰
- åŸºäº GPT-o3 é£æ ¼çš„æ¨ç†æ§åˆ¶å™¨

**æ ¸å¿ƒæ–¹æ³•**:
```python
forward(h, lm_head, return_details=False)
  - è¾“å…¥: hidden states
  - è¾“å‡º: reasoned hidden states + æ¨ç†ä¿¡æ¯
  - æœ€å¤š max_steps æ­¥
  - åŸºäºå¤šæ¡ä»¶åœæ­¢
```

**ç‰¹ç‚¹**:
- âœ… è‡ªé€‚åº”åœæ­¢
- âœ… å¤šæ¡ä»¶æ”¶æ•›æ£€æµ‹
- âœ… è¯¦ç»†çš„æ­¥éª¤è¿½è¸ª
- âœ… Patience æœºåˆ¶

---

#### âœ… BudgetedReasoningController
**æ–‡ä»¶**: `apt_model/runtime/decoder/reasoning_controller.py:186-290`

**åŠŸèƒ½**:
- å¸¦é¢„ç®—çº¦æŸçš„æ¨ç†æ§åˆ¶å™¨
- åªå¯¹ä¸ç¡®å®šçš„ token è¿›è¡Œæ¨ç†
- åŸºäºç†µé€‰æ‹©æ¨ç† token
- å…¨å±€é¢„ç®—æ§åˆ¶

**æ ¸å¿ƒæ–¹æ³•**:
```python
forward(h, lm_head, return_details=False)
  - ä½¿ç”¨ BudgetedHalting é€‰æ‹©æ¨ç† token
  - åªå¯¹é€‰ä¸­çš„ token æ‰§è¡Œæ¨ç†
  - æ§åˆ¶è®¡ç®—æˆæœ¬
```

**ç‰¹ç‚¹**:
- âœ… è®¡ç®—æˆæœ¬æ§åˆ¶
- âœ… é€‰æ‹©æ€§æ¨ç†ï¼ˆåªå¯¹é«˜ç†µ tokenï¼‰
- âœ… å…¨å±€é¢„ç®—é™åˆ¶
- âœ… æ•ˆç‡ä¼˜åŒ–

---

#### âœ… AdaptiveBudgetController
**æ–‡ä»¶**: `apt_model/runtime/decoder/reasoning_controller.py:292-369`

**åŠŸèƒ½**:
- åŠ¨æ€è°ƒæ•´æ¨ç†é¢„ç®—
- åŸºäºæ¨¡å‹æ€§èƒ½è‡ªé€‚åº”
- ä¸ç¡®å®šæ—¶å¢åŠ é¢„ç®—
- è‡ªä¿¡æ—¶å‡å°‘é¢„ç®—

**æ ¸å¿ƒæ–¹æ³•**:
```python
adapt_budget(avg_entropy, avg_steps)
  - æ ¹æ®å¹³å‡ç†µå’Œæ­¥æ•°è°ƒæ•´é¢„ç®—
  - è‡ªåŠ¨å¹³è¡¡è´¨é‡å’Œæ•ˆç‡
```

**ç‰¹ç‚¹**:
- âœ… åŠ¨æ€é¢„ç®—è°ƒæ•´
- âœ… åŸºäºæ€§èƒ½è‡ªé€‚åº”
- âœ… å¹³è¡¡è´¨é‡å’Œæˆæœ¬

---

### 2. ç»“æ„åŒ–æ¨ç†å™¨

#### âœ… StructuredReasoner
**æ–‡ä»¶**: `apt_model/runtime/decoder/structured_reasoner.py:18-128`

**åŠŸèƒ½**:
- å•æ­¥ç»“æ„åŒ–æ¨ç†
- Vein subspace projection
- MoE ä¸“å®¶è·¯ç”±
- Learned halting

**æ¨ç†æµç¨‹**:
```
1. æŠ•å½±åˆ° vein subspace: z = V^T h
2. è·¯ç”±åˆ° top-k experts
3. ä¸“å®¶æ··åˆ: z_new = Î£ weight_k * Expert_k(z)
4. é‡å»ºåˆ°å…¨ç»´åº¦: h_new = U z_new
5. è®¡ç®—åœæ­¢æ¦‚ç‡: p_halt = sigmoid(W h_new)
```

**ç‰¹ç‚¹**:
- âœ… ä½ç§©å­ç©ºé—´æ¨ç†
- âœ… MoE ä¸“å®¶è·¯ç”±
- âœ… æ®‹å·®æ··åˆ
- âœ… åœæ­¢æ¦‚ç‡å­¦ä¹ 

---

#### âœ… ChainOfThoughtReasoner
**æ–‡ä»¶**: `apt_model/runtime/decoder/structured_reasoner.py:130-199`

**åŠŸèƒ½**:
- Chain-of-Thought é£æ ¼æ¨ç†
- å›ºå®šæ­¥æ•°çš„é¡ºåºæ¨ç†
- æ— åœæ­¢æœºåˆ¶ï¼ˆå›ºå®šé“¾ï¼‰

**ç‰¹ç‚¹**:
- âœ… å›ºå®šæ­¥æ•°æ¨ç†
- âœ… å‚æ•°å¯å…±äº«æˆ–ç‹¬ç«‹
- âœ… ä¸­é—´çŠ¶æ€è¿½è¸ª

---

### 3. æ¨ç†è®­ç»ƒ

#### âœ… train_reasoning_model
**æ–‡ä»¶**: `apt_model/training/train_reasoning.py:188-354`

**åŠŸèƒ½**:
- è®­ç»ƒæ¨ç†å¢å¼ºæ¨¡å‹
- ä½¿ç”¨æ¨ç†æ•°æ®é›†
- æ”¯æŒå¸¦é¢„ç®—å’Œä¸å¸¦é¢„ç®—çš„æ¨ç†
- æ¢¯åº¦è£å‰ªå’Œä¼˜åŒ–

**æ•°æ®æ ¼å¼**:
```python
{
    'input': 'é—®é¢˜',
    'reasoning_steps': ['æ­¥éª¤1', 'æ­¥éª¤2', ...],
    'output': 'ç­”æ¡ˆ'
}
```

**ç‰¹ç‚¹**:
- âœ… å®Œæ•´çš„è®­ç»ƒæµç¨‹
- âœ… è¾…åŠ©æŸå¤±æ”¯æŒ
- âœ… æ¨ç†æ­¥æ•°è¿½è¸ª
- âœ… æ¨¡å‹ä¿å­˜

---

#### âœ… ReasoningDataset
**æ–‡ä»¶**: `apt_model/training/train_reasoning.py:23-83`

**åŠŸèƒ½**:
- æ¨ç†æ•°æ®é›†ç±»
- æ”¯æŒä¸­é—´æ­¥éª¤
- è‡ªåŠ¨æ ¼å¼åŒ–

**æ ¼å¼åŒ–æ–¹å¼**:
```
å¸¦æ­¥éª¤:
Question: {input}
Step 1: {step_1}
Step 2: {step_2}
...
Answer: {output}

ä¸å¸¦æ­¥éª¤:
Question: {input}
Answer: {output}
```

---

## âŒ ç¼ºå¤±çš„é«˜çº§æ¨ç†åŠŸèƒ½

æ ¹æ®å½“å‰æµè¡Œçš„æ¨ç†æŠ€æœ¯å’Œ NEW_UPLOADS_SUMMARY.md çš„å»ºè®®ï¼Œä»¥ä¸‹åŠŸèƒ½å°šæœªå®ç°ï¼š

### 1. Self-Consistency Decoding (è‡ªæ´½æ€§è§£ç ) âŒ

**æè¿°**:
- ç”Ÿæˆå¤šä¸ªæ¨ç†è·¯å¾„
- é€šè¿‡æŠ•ç¥¨é€‰æ‹©æœ€ä¸€è‡´çš„ç­”æ¡ˆ
- æé«˜æ¨ç†å¯é æ€§

**ç¼ºå¤±åŸå› **: é¡¹ç›®ä¸­æœªæ‰¾åˆ°ç›¸å…³å®ç°

**ä¼˜å…ˆçº§**: â­â­â­â­â­ (é«˜)

**å‚è€ƒ**: Wang et al., "Self-Consistency Improves Chain of Thought Reasoning" (2022)

---

### 2. Beam Search Reasoning (æŸæœç´¢æ¨ç†) âŒ

**æè¿°**:
- ç»´æŠ¤å¤šä¸ªå€™é€‰æ¨ç†è·¯å¾„
- åŸºäºå¾—åˆ†é€‰æ‹©æœ€ä½³è·¯å¾„
- å¹³è¡¡æ¢ç´¢ä¸åˆ©ç”¨

**ç¼ºå¤±åŸå› **: é¡¹ç›®ä¸­æœªæ‰¾åˆ°ç›¸å…³å®ç°

**ä¼˜å…ˆçº§**: â­â­â­â­ (ä¸­é«˜)

---

### 3. Tree-of-Thought (æ€ç»´æ ‘) âŒ

**æè¿°**:
- æ„å»ºæ¨ç†æ ‘ç»“æ„
- å¹¿åº¦ä¼˜å…ˆ/æ·±åº¦ä¼˜å…ˆæ¢ç´¢
- å›æº¯å’Œå‰ªææœºåˆ¶

**ç¼ºå¤±åŸå› **: é¡¹ç›®ä¸­æœªæ‰¾åˆ°ç›¸å…³å®ç°

**ä¼˜å…ˆçº§**: â­â­â­ (ä¸­)

**å‚è€ƒ**: Yao et al., "Tree of Thoughts" (2023)

---

### 4. Least-to-Most Prompting âŒ

**æè¿°**:
- åˆ†è§£å¤æ‚é—®é¢˜ä¸ºå­é—®é¢˜
- ä»ç®€å•åˆ°å¤æ‚é€æ­¥æ±‚è§£
- å­é—®é¢˜ç­”æ¡ˆç»„åˆ

**ç¼ºå¤±åŸå› **: é¡¹ç›®ä¸­æœªæ‰¾åˆ°ç›¸å…³å®ç°

**ä¼˜å…ˆçº§**: â­â­â­ (ä¸­)

---

### 5. Program-Aided Reasoning (ç¨‹åºè¾…åŠ©æ¨ç†) âŒ

**æè¿°**:
- ç”Ÿæˆå¯æ‰§è¡Œä»£ç 
- æ‰§è¡Œä»£ç è·å–ä¸­é—´ç»“æœ
- ç»“åˆç¬¦å·è®¡ç®—å’Œç¥ç»æ¨ç†

**ç¼ºå¤±åŸå› **: é¡¹ç›®ä¸­æœªæ‰¾åˆ°ç›¸å…³å®ç°

**ä¼˜å…ˆçº§**: â­â­â­â­ (ä¸­é«˜)

**å‚è€ƒ**: PAL, PoT (Program of Thoughts)

---

### 6. Reflexion (åæ€æ¨ç†) âŒ

**æè¿°**:
- æ¨¡å‹è‡ªæˆ‘åæ€
- ä»é”™è¯¯ä¸­å­¦ä¹ 
- è¿­ä»£æ”¹è¿›æ¨ç†

**ç¼ºå¤±åŸå› **: é¡¹ç›®ä¸­æœªæ‰¾åˆ°ç›¸å…³å®ç°

**ä¼˜å…ˆçº§**: â­â­ (ä½)

**å‚è€ƒ**: Shinn et al., "Reflexion" (2023)

---

## ğŸ¯ æ¨èåˆ›å»ºçš„æ¨ç†æ’ä»¶

åŸºäºä¸Šè¿°åˆ†æï¼Œå»ºè®®åˆ›å»ºä»¥ä¸‹æ¨ç†æ’ä»¶ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ï¼š

### ä¼˜å…ˆçº§ 1: å¿…é¡»å®ç° â­â­â­â­â­

#### 1. **Self-Consistency Plugin**
```python
class SelfConsistencyPlugin(PluginBase):
    """
    è‡ªæ´½æ€§è§£ç æ’ä»¶

    åŠŸèƒ½:
    - ç”Ÿæˆ N ä¸ªç‹¬ç«‹æ¨ç†è·¯å¾„ (temperature sampling)
    - æå–æ¯ä¸ªè·¯å¾„çš„æœ€ç»ˆç­”æ¡ˆ
    - å¤šæ•°æŠ•ç¥¨é€‰æ‹©æœ€ä¸€è‡´çš„ç­”æ¡ˆ
    - è¿½è¸ªç­”æ¡ˆåˆ†å¸ƒå’Œç½®ä¿¡åº¦
    """
```

**äº‹ä»¶**: `on_inference_start`, `on_decode`

**ä¼˜åŠ¿**:
- æ˜¾è‘—æé«˜æ¨ç†å‡†ç¡®ç‡
- ç®€å•æœ‰æ•ˆ
- é€‚ç”¨äºå¤šç§ä»»åŠ¡

---

### ä¼˜å…ˆçº§ 2: å¼ºçƒˆæ¨è â­â­â­â­

#### 2. **Beam Search Reasoning Plugin**
```python
class BeamSearchReasoningPlugin(PluginBase):
    """
    æŸæœç´¢æ¨ç†æ’ä»¶

    åŠŸèƒ½:
    - ç»´æŠ¤ k ä¸ªå€™é€‰æ¨ç†è·¯å¾„
    - æ¯æ­¥æ‰©å±•å¹¶è¯„åˆ†
    - ä¿ç•™ top-k è·¯å¾„
    - è¿”å›æœ€é«˜åˆ†è·¯å¾„
    """
```

**äº‹ä»¶**: `on_inference_start`, `on_step_end`

**ä¼˜åŠ¿**:
- æ¢ç´¢å¤šä¸ªæ¨ç†æ–¹å‘
- å¯æ§çš„è®¡ç®—æˆæœ¬
- é€‚åˆé•¿æ¨ç†é“¾

---

#### 3. **Program-Aided Reasoning Plugin**
```python
class ProgramAidedReasoningPlugin(PluginBase):
    """
    ç¨‹åºè¾…åŠ©æ¨ç†æ’ä»¶ (PAL/PoT)

    åŠŸèƒ½:
    - ç”Ÿæˆ Python ä»£ç 
    - æ‰§è¡Œä»£ç è·å–ç»“æœ
    - æ²™ç®±ç¯å¢ƒä¿æŠ¤
    - ç»“æœéªŒè¯
    """
```

**äº‹ä»¶**: `on_inference_start`, `on_decode`

**ä¼˜åŠ¿**:
- ç²¾ç¡®çš„æ•°å€¼è®¡ç®—
- å¤æ‚é€»è¾‘æ¨ç†
- å¯è§£é‡Šæ€§å¼º

---

### ä¼˜å…ˆçº§ 3: æ¨èå®ç° â­â­â­

#### 4. **Tree-of-Thought Plugin**
```python
class TreeOfThoughtPlugin(PluginBase):
    """
    æ€ç»´æ ‘æ’ä»¶

    åŠŸèƒ½:
    - æ„å»ºæ¨ç†æ ‘
    - BFS/DFS æœç´¢
    - èŠ‚ç‚¹è¯„ä¼°å’Œå‰ªæ
    - æœ€ä¼˜è·¯å¾„é€‰æ‹©
    """
```

**äº‹ä»¶**: `on_inference_start`, `on_decode`

**ä¼˜åŠ¿**:
- ç³»ç»ŸåŒ–æ¢ç´¢æ¨ç†ç©ºé—´
- æ”¯æŒå›æº¯
- é€‚åˆè§„åˆ’ä»»åŠ¡

---

#### 5. **Least-to-Most Decomposition Plugin**
```python
class LeastToMostPlugin(PluginBase):
    """
    æœ€ç®€åˆ°æœ€å¤æ‚åˆ†è§£æ’ä»¶

    åŠŸèƒ½:
    - åˆ†è§£å¤æ‚é—®é¢˜
    - è¯†åˆ«å­é—®é¢˜ä¾èµ–
    - é¡ºåºæ±‚è§£å­é—®é¢˜
    - ç»„åˆå­ç­”æ¡ˆ
    """
```

**äº‹ä»¶**: `on_inference_start`

**ä¼˜åŠ¿**:
- å¤„ç†å¤æ‚é—®é¢˜
- ç»“æ„åŒ–æ¨ç†
- å¯å¤ç”¨å­è§£

---

## ğŸ“‹ ç°æœ‰ vs ç¼ºå¤±å¯¹æ¯”è¡¨

| æ¨ç†æŠ€æœ¯ | çŠ¶æ€ | å®ç°ä½ç½® | ä¼˜å…ˆçº§ |
|---------|------|---------|--------|
| **åŸºç¡€æ¨ç†** |
| Multi-step Reasoning | âœ… å·²å®ç° | ReasoningController | - |
| Adaptive Halting | âœ… å·²å®ç° | MultiCriteriaHalting | - |
| Budgeted Reasoning | âœ… å·²å®ç° | BudgetedReasoningController | - |
| MoE Expert Routing | âœ… å·²å®ç° | StructuredReasoner | - |
| Chain-of-Thought | âœ… å·²å®ç° | ChainOfThoughtReasoner | - |
| **é«˜çº§æ¨ç†** |
| Self-Consistency | âŒ æœªå®ç° | - | â­â­â­â­â­ |
| Beam Search Reasoning | âŒ æœªå®ç° | - | â­â­â­â­ |
| Program-Aided (PAL/PoT) | âŒ æœªå®ç° | - | â­â­â­â­ |
| Tree-of-Thought | âŒ æœªå®ç° | - | â­â­â­ |
| Least-to-Most | âŒ æœªå®ç° | - | â­â­â­ |
| Reflexion | âŒ æœªå®ç° | - | â­â­ |

---

## ğŸ¨ æ¨èçš„æ’ä»¶æ¶æ„

### ç›®å½•ç»“æ„

```
apt_model/console/plugins/reasoning/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ self_consistency_plugin.py      # è‡ªæ´½æ€§è§£ç 
â”œâ”€â”€ beam_search_plugin.py           # æŸæœç´¢æ¨ç†
â”œâ”€â”€ program_aided_plugin.py         # ç¨‹åºè¾…åŠ©æ¨ç†
â”œâ”€â”€ tree_of_thought_plugin.py       # æ€ç»´æ ‘
â”œâ”€â”€ least_to_most_plugin.py         # æœ€ç®€åˆ°æœ€å¤æ‚
â””â”€â”€ reflexion_plugin.py             # åæ€æ¨ç† (å¯é€‰)
```

### æ’ä»¶ä¼˜å…ˆçº§è®¾ç½®

æ ¹æ® memo.txt çš„æ’ä»¶ä¼˜å…ˆçº§æ ‡å‡†ï¼š

| æ’ä»¶ | ä¼˜å…ˆçº§ç±»åˆ« | æ•°å€¼ | åŸå›  |
|-----|-----------|------|------|
| Self-Consistency | Reasoning | 280 | æ¨ç†å¢å¼ºï¼Œå±äº Reasoning tier |
| Beam Search | Reasoning | 300 | æ¨ç†æœç´¢ï¼Œå±äº Reasoning tier |
| Program-Aided | Reasoning | 320 | ç¬¦å·æ¨ç†ï¼Œå±äº Reasoning tier |
| Tree-of-Thought | Reasoning | 290 | æ¨ç†æ¢ç´¢ï¼Œå±äº Reasoning tier |
| Least-to-Most | Reasoning | 310 | é—®é¢˜åˆ†è§£ï¼Œå±äº Reasoning tier |

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **åˆ›å»º Self-Consistency Plugin** (ä¼˜å…ˆçº§ 1)
   - å®ç°å¤šè·¯å¾„é‡‡æ ·
   - å®ç°ç­”æ¡ˆæå–å’ŒæŠ•ç¥¨
   - é›†æˆåˆ°æ¨ç†æ§åˆ¶å™¨

2. **åˆ›å»º Beam Search Reasoning Plugin** (ä¼˜å…ˆçº§ 2)
   - å®ç°æŸæœç´¢ç®—æ³•
   - è·¯å¾„è¯„åˆ†æœºåˆ¶
   - Top-k é€‰æ‹©

3. **åˆ›å»º Program-Aided Reasoning Plugin** (ä¼˜å…ˆçº§ 2)
   - ä»£ç ç”Ÿæˆ
   - æ²™ç®±æ‰§è¡Œç¯å¢ƒ
   - ç»“æœéªŒè¯

4. **æµ‹è¯•å’ŒéªŒè¯**
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

5. **æ–‡æ¡£å’Œç¤ºä¾‹**
   - ä½¿ç”¨æŒ‡å—
   - ç¤ºä¾‹ä»£ç 
   - æ€§èƒ½å¯¹æ¯”

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

### ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

1. **å¤ç”¨ç°æœ‰ç»„ä»¶**:
   - ä½¿ç”¨ `ReasoningController` ä½œä¸ºåŸºç¡€
   - å¤ç”¨ `StructuredReasoner` çš„ä¸“å®¶è·¯ç”±
   - å¤ç”¨ `MultiCriteriaHalting` çš„åœæ­¢æœºåˆ¶

2. **é€‚é… PluginBase ç³»ç»Ÿ**:
   - æ‰€æœ‰æ–°æ’ä»¶ç»§æ‰¿ `PluginBase`
   - å®ç° `get_manifest()` æ–¹æ³•
   - è®¢é˜…é€‚å½“çš„äº‹ä»¶

3. **æ€§èƒ½è€ƒè™‘**:
   - Self-Consistency ä¼šå¢åŠ  N å€è®¡ç®—ï¼ˆN = é‡‡æ ·æ¬¡æ•°ï¼‰
   - Beam Search ä¼šå¢åŠ  k å€è®¡ç®—ï¼ˆk = beam sizeï¼‰
   - Program-Aided éœ€è¦ä»£ç æ‰§è¡Œå¼€é”€

---

**åˆ†æå®Œæˆï¼å‡†å¤‡åˆ›å»ºæ¨ç†æ’ä»¶ã€‚**
