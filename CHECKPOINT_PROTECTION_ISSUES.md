# è®­ç»ƒCheckpointä¿æŠ¤æœºåˆ¶é—®é¢˜æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-27
**é—®é¢˜**: ç”µè„‘çªç„¶å…³æœºå¯¼è‡´AIè®­ç»ƒè¿›åº¦ä¸¢å¤±
**å½±å“**: ä¸¥é‡ - å¯èƒ½å¯¼è‡´æ•°å°æ—¶çš„è®­ç»ƒç™½è´¹

---

## ğŸ”´ å‘ç°çš„ä¸¥é‡é—®é¢˜

### 1. **åªåœ¨æœ€ä½³æ¨¡å‹æ—¶ä¿å­˜** âš ï¸
**ä½ç½®**: `apt_model/training/trainer.py:763-766`

```python
if avg_loss < best_loss:
    best_loss = avg_loss
    save_model(model, tokenizer, path=save_path, config=config)
    info_print(f"å‘ç°æ–°çš„æœ€ä½³æ¨¡å‹ï¼Œå·²ä¿å­˜åˆ° {save_path}")
```

**é—®é¢˜**:
- åªæœ‰å½“æŸå¤±æ”¹å–„æ—¶æ‰ä¿å­˜æ¨¡å‹
- å¦‚æœè®­ç»ƒåˆ°åæœŸï¼Œlossæ²¡æœ‰æ”¹å–„ï¼Œæœ€åå‡ ä¸ªepochçš„è¿›åº¦ä¸ä¼šè¢«ä¿å­˜
- å¦‚æœåœ¨æŸä¸ªepochä¸­é—´å´©æºƒï¼Œæ•´ä¸ªepochçš„è¿›åº¦ä¸¢å¤±

**é£é™©**: é«˜

---

### 2. **åªåœ¨Epochç»“æŸæ—¶ä¿å­˜** âš ï¸
**é—®é¢˜**:
- æ²¡æœ‰batchçº§åˆ«çš„å®šæœŸä¿å­˜
- å¦‚æœä¸€ä¸ªepochéœ€è¦2å°æ—¶ï¼Œä¸­é€”å´©æºƒä¼šä¸¢å¤±æ‰€æœ‰è¿›åº¦
- é•¿æ—¶é—´è®­ç»ƒçš„é£é™©æé«˜

**é£é™©**: ä¸¥é‡

---

### 3. **æ²¡æœ‰ä½¿ç”¨CheckpointManager** âš ï¸
**ä½ç½®**: `apt_model/training/checkpoint.py:78-258`

**å‘ç°**:
- CheckpointManagerç±»å·²ç»å®ç°ï¼ŒåŠŸèƒ½å®Œå–„ï¼š
  - ä¿å­˜optimizerå’ŒschedulerçŠ¶æ€
  - ä¿å­˜è®­ç»ƒå†å²å’Œmetrics
  - æ”¯æŒåŠ è½½æœ€æ–°/æœ€ä½³checkpoint
  - å…ƒæ•°æ®ç®¡ç†
- **ä½†æ˜¯è®­ç»ƒå™¨å®Œå…¨æ²¡æœ‰ä½¿ç”¨å®ƒï¼**

**å½±å“**:
- æ— æ³•ä¿å­˜ä¼˜åŒ–å™¨çŠ¶æ€ â†’ æ¢å¤è®­ç»ƒåå­¦ä¹ ç‡ä¼šé‡ç½®
- æ— æ³•ä¿å­˜schedulerçŠ¶æ€ â†’ warmupç­‰è°ƒåº¦ç­–ç•¥ä¼šé‡æ–°å¼€å§‹
- æ— æ³•è®°å½•è®­ç»ƒå†å² â†’ æ— æ³•ç»§ç»­ä¹‹å‰çš„è®­ç»ƒæ›²çº¿

**é£é™©**: ä¸¥é‡

---

### 4. **æ²¡æœ‰è‡ªåŠ¨æ¢å¤æœºåˆ¶** âš ï¸
**é—®é¢˜**:
- æ²¡æœ‰æ£€æµ‹å·²æœ‰checkpointå¹¶è‡ªåŠ¨æ¢å¤çš„åŠŸèƒ½
- ç”¨æˆ·å¿…é¡»æ‰‹åŠ¨æŒ‡å®šcheckpointè·¯å¾„
- å³ä½¿æœ‰checkpointä¹Ÿå¯èƒ½å› ä¸çŸ¥é“å¦‚ä½•æ¢å¤è€Œé‡æ–°è®­ç»ƒ

**é£é™©**: é«˜

---

### 5. **æ²¡æœ‰å¼‚å¸¸å¤„ç†ä¿æŠ¤** âš ï¸
**é—®é¢˜**:
- æ²¡æœ‰try-exceptåŒ…è£¹è®­ç»ƒå¾ªç¯
- æ²¡æœ‰signal handleræ•è·SIGINT/SIGTERM
- çªç„¶æ–­ç”µ/å´©æºƒæ—¶æ— æ³•ä¿å­˜æœ€åçŠ¶æ€

**é£é™©**: ä¸¥é‡

---

### 6. **æ²¡æœ‰å®šæœŸè‡ªåŠ¨ä¿å­˜** âš ï¸
**å½“å‰çŠ¶æ€**:
- ä¿å­˜é¢‘ç‡ï¼šä»…åœ¨epochç»“æŸä¸”lossæ”¹å–„æ—¶
- æ²¡æœ‰æ—¶é—´è§¦å‘çš„ä¿å­˜ï¼ˆå¦‚æ¯30åˆ†é’Ÿï¼‰
- æ²¡æœ‰æ­¥æ•°è§¦å‘çš„ä¿å­˜ï¼ˆå¦‚æ¯1000æ­¥ï¼‰

**å»ºè®®**:
- æ¯Nä¸ªbatchä¿å­˜ä¸€æ¬¡ï¼ˆå¦‚æ¯500æ­¥ï¼‰
- æ¯éš”å›ºå®šæ—¶é—´ä¿å­˜ä¸€æ¬¡ï¼ˆå¦‚æ¯30åˆ†é’Ÿï¼‰
- åŒæ—¶ä¿ç•™å¤šä¸ªcheckpointï¼ˆå¦‚æœ€è¿‘5ä¸ªï¼‰

**é£é™©**: é«˜

---

## ğŸ“Š é—®é¢˜å½±å“åˆ†æ

### ç”¨æˆ·åœºæ™¯ï¼š
1. **è®­ç»ƒè¿›è¡Œäº†5å°æ—¶**
2. **ç”µè„‘çªç„¶å…³æœº**ï¼ˆæ–­ç”µ/è“å±/å´©æºƒï¼‰
3. **ç»“æœ**:
   - å¦‚æœæœ€åä¸€ä¸ªepochçš„lossæ²¡æœ‰æ”¹å–„ â†’ **5å°æ—¶ç™½è´¹**
   - å¦‚æœåœ¨epochä¸­é—´å´©æºƒ â†’ **è‡³å°‘ä¸¢å¤±å½“å‰epochçš„æ‰€æœ‰è¿›åº¦**

### å…·ä½“ä¾‹å­ï¼š
```
Epoch 1: loss=2.5 â†’ ä¿å­˜ âœ“
Epoch 2: loss=2.3 â†’ ä¿å­˜ âœ“
Epoch 3: loss=2.1 â†’ ä¿å­˜ âœ“
Epoch 4: loss=2.2 (æ²¡æœ‰æ”¹å–„) â†’ ä¸ä¿å­˜ âœ—
Epoch 5: loss=2.15 â†’ æ­£åœ¨è®­ç»ƒä¸­... [çªç„¶å…³æœº]
ç»“æœï¼šåªæœ‰Epoch 3çš„æ¨¡å‹è¢«ä¿å­˜ï¼ŒEpoch 4-5çš„4ä¸ªepochè¿›åº¦å…¨éƒ¨ä¸¢å¤±ï¼
```

---

## âœ… å·²æœ‰ä½†æœªä½¿ç”¨çš„åŠŸèƒ½

### CheckpointManager åŠŸèƒ½æ¸…å•ï¼š
- âœ… ä¿å­˜å®Œæ•´è®­ç»ƒçŠ¶æ€ï¼ˆæ¨¡å‹+optimizer+schedulerï¼‰
- âœ… å…ƒæ•°æ®ç®¡ç†ï¼ˆè®­ç»ƒå†å²ã€metricsï¼‰
- âœ… æ”¯æŒåŠ è½½latest/best checkpoint
- âœ… è‡ªåŠ¨åˆ›å»ºcheckpointç›®å½•
- âœ… ä¿å­˜é¢‘ç‡æ§åˆ¶ï¼ˆsave_freqå‚æ•°ï¼‰

### ä¸ºä»€ä¹ˆæ²¡ç”¨ï¼Ÿ
- è®­ç»ƒå™¨ä»£ç ä½¿ç”¨äº†ç®€å•çš„`save_model()`å‡½æ•°
- æ²¡æœ‰é›†æˆCheckpointManager
- å¯èƒ½æ˜¯å†å²é—ç•™ä»£ç é—®é¢˜

---

## ğŸ› ï¸ å»ºè®®çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆA: å¿«é€Ÿä¿®å¤ï¼ˆ1-2å°æ—¶ï¼‰
**é€‚ç”¨äº**: ç«‹å³éœ€è¦ä¿æŠ¤ä»Šæ™šçš„è®­ç»ƒ

1. **åœ¨è®­ç»ƒå™¨ä¸­é›†æˆCheckpointManager**
2. **æ·»åŠ å®šæœŸä¿å­˜**:
   ```python
   # æ¯500æ­¥ä¿å­˜ä¸€æ¬¡
   if global_step % 500 == 0:
       checkpoint_manager.save_checkpoint(...)
   ```
3. **æ¯ä¸ªepochç»“æŸéƒ½ä¿å­˜**ï¼ˆä¸ç®¡lossæ˜¯å¦æ”¹å–„ï¼‰
4. **ä¿ç•™æœ€è¿‘Nä¸ªcheckpoint**ï¼ˆå¦‚5ä¸ªï¼‰

### æ–¹æ¡ˆB: å®Œæ•´æ–¹æ¡ˆï¼ˆ3-4å°æ—¶ï¼‰
**åŒ…å«æ–¹æ¡ˆA +**:

5. **æ·»åŠ è‡ªåŠ¨æ¢å¤åŠŸèƒ½**:
   ```python
   # æ£€æµ‹å·²æœ‰checkpointå¹¶è¯¢é—®æ˜¯å¦æ¢å¤
   if checkpoint_manager.has_checkpoints():
       if auto_resume or user_confirms():
           epoch, step = checkpoint_manager.load_checkpoint(latest=True)
   ```

6. **æ·»åŠ å¼‚å¸¸å¤„ç†å’Œä¿¡å·æ•è·**:
   ```python
   import signal

   def save_on_interrupt(signum, frame):
       checkpoint_manager.save_checkpoint(..., is_emergency=True)
       sys.exit(0)

   signal.signal(signal.SIGINT, save_on_interrupt)
   signal.signal(signal.SIGTERM, save_on_interrupt)
   ```

7. **æ·»åŠ æ—¶é—´è§¦å‘ä¿å­˜**:
   ```python
   last_save_time = time.time()
   if time.time() - last_save_time > 30 * 60:  # 30åˆ†é’Ÿ
       checkpoint_manager.save_checkpoint(...)
   ```

8. **æ·»åŠ ç£ç›˜ç©ºé—´æ£€æŸ¥**
9. **æ·»åŠ checkpointæ¸…ç†ç­–ç•¥**ï¼ˆä¿ç•™æœ€è¿‘5ä¸ª+æœ€ä½³1ä¸ªï¼‰

### æ–¹æ¡ˆC: ä¼ä¸šçº§æ–¹æ¡ˆï¼ˆ6-8å°æ—¶ï¼‰
**åŒ…å«æ–¹æ¡ˆB +**:

10. **åˆ†å¸ƒå¼è®­ç»ƒæ”¯æŒ**
11. **Cloud storageå¤‡ä»½**ï¼ˆS3/OSSï¼‰
12. **Checkpointå‹ç¼©**
13. **å¢é‡checkpoint**ï¼ˆåªä¿å­˜å˜åŒ–çš„å‚æ•°ï¼‰
14. **è®­ç»ƒå¯è§†åŒ–Dashboard**

---

## ğŸ¯ æ¨èè¡ŒåŠ¨è®¡åˆ’

### ç«‹å³è¡ŒåŠ¨ï¼ˆä»Šå¤©å®Œæˆï¼‰:
**æ–¹æ¡ˆA - å¿«é€Ÿä¿®å¤**

1. âœ… é›†æˆCheckpointManageråˆ°trainer.py
2. âœ… æ·»åŠ æ¯Næ­¥è‡ªåŠ¨ä¿å­˜ï¼ˆå»ºè®®500-1000æ­¥ï¼‰
3. âœ… æ¯ä¸ªepochç»“æŸéƒ½ä¿å­˜
4. âœ… ä¿ç•™æœ€è¿‘5ä¸ªcheckpoint

**é¢„è®¡æ—¶é—´**: 1-2å°æ—¶
**æ•ˆæœ**: æœ€å¤šä¸¢å¤±500-1000æ­¥çš„è¿›åº¦ï¼ˆç›¸æ¯”ç°åœ¨å¯èƒ½ä¸¢å¤±æ•´ä¸ªepochï¼‰

### åç»­å¢å¼ºï¼ˆæ˜å¤©æˆ–ä¸‹å‘¨ï¼‰:
**æ–¹æ¡ˆB - å®Œæ•´æ–¹æ¡ˆ**

5. â³ æ·»åŠ è‡ªåŠ¨æ¢å¤åŠŸèƒ½
6. â³ æ·»åŠ å¼‚å¸¸å¤„ç†å’Œä¿¡å·æ•è·
7. â³ æ·»åŠ æ—¶é—´è§¦å‘ä¿å­˜

**é¢„è®¡æ—¶é—´**: é¢å¤–2-3å°æ—¶
**æ•ˆæœ**: æ¥è¿‘100%çš„è®­ç»ƒè¿›åº¦ä¿æŠ¤

---

## ğŸ’¡ ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼ˆç«‹å³å¯ç”¨ï¼‰

**å¦‚æœä»Šæ™šå°±è¦è®­ç»ƒï¼Œç­‰ä¸åŠä»£ç ä¿®æ”¹**:

### æ‰‹åŠ¨ä¿æŠ¤ç­–ç•¥ï¼š
1. **å‡å°epochå¤§å°**: å¦‚æœåŸæœ¬1ä¸ªepoch=10000æ­¥ï¼Œæ”¹ä¸ºæ¯2000æ­¥ä¸€ä¸ªepoch
   - è¿™æ ·æ¯2000æ­¥ä¼šè§¦å‘ä¿å­˜æ£€æŸ¥

2. **ä½¿ç”¨screen/tmux**:
   ```bash
   tmux new -s training
   python -m apt_model train ...
   # Ctrl+B, D æ¥detach
   ```
   - å³ä½¿SSHæ–­å¼€ä¹Ÿä¸ä¼šä¸­æ–­è®­ç»ƒ

3. **å®šæœŸæ‰‹åŠ¨æ£€æŸ¥**:
   - æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è®­ç»ƒçŠ¶æ€
   - ç¡®ä¿æœ‰æœ€æ–°çš„checkpoint

4. **ä½¿ç”¨UPSï¼ˆä¸é—´æ–­ç”µæºï¼‰**:
   - å¦‚æœæ˜¯æ–­ç”µé—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨UPS

---

## ğŸ“ ä»£ç æ”¹è¿›ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | é¢„è®¡æ—¶é—´ | é˜²æŠ¤æ•ˆæœ |
|--------|--------|----------|----------|
| ğŸ”´ ç´§æ€¥ | é›†æˆCheckpointManager | 30åˆ†é’Ÿ | 60% |
| ğŸ”´ ç´§æ€¥ | æ¯Næ­¥è‡ªåŠ¨ä¿å­˜ | 20åˆ†é’Ÿ | 90% |
| ğŸ”´ ç´§æ€¥ | æ¯epochéƒ½ä¿å­˜ | 10åˆ†é’Ÿ | 95% |
| ğŸŸ¡ é‡è¦ | è‡ªåŠ¨æ¢å¤åŠŸèƒ½ | 1å°æ—¶ | 98% |
| ğŸŸ¡ é‡è¦ | å¼‚å¸¸å¤„ç†ä¿å­˜ | 1å°æ—¶ | 99% |
| ğŸŸ¢ å»ºè®® | æ—¶é—´è§¦å‘ä¿å­˜ | 30åˆ†é’Ÿ | 99.5% |
| ğŸŸ¢ å»ºè®® | Cloudå¤‡ä»½ | 2å°æ—¶ | 99.9% |

---

## ğŸš€ ç«‹å³å¯æ‰§è¡Œçš„ä»£ç ç‰‡æ®µ

### å¿«é€Ÿä¿®å¤ä»£ç ï¼ˆæ’å…¥åˆ°trainer.pyï¼‰:

```python
# åœ¨è®­ç»ƒå¼€å§‹å‰åˆå§‹åŒ–CheckpointManager
from apt_model.training.checkpoint import CheckpointManager

checkpoint_manager = CheckpointManager(
    save_dir=save_path,
    model_name="apt_model",
    save_freq=1,  # æ¯ä¸ªepoch
    logger=logger
)

# åœ¨è®­ç»ƒå¾ªç¯ä¸­æ·»åŠ ï¼ˆbatchçº§åˆ«ï¼‰
SAVE_EVERY_N_STEPS = 500  # æ¯500æ­¥ä¿å­˜ä¸€æ¬¡

if global_step % SAVE_EVERY_N_STEPS == 0:
    checkpoint_manager.save_checkpoint(
        model=model,
        optimizer=optimizer,
        scheduler=scheduler,
        epoch=epoch,
        global_step=global_step,
        loss_history=train_losses,
        tokenizer=tokenizer,
        config=config
    )
    info_print(f"è‡ªåŠ¨ä¿å­˜checkpoint at step {global_step}")

# åœ¨epochç»“æŸæ—¶ä¹Ÿä¿å­˜ï¼ˆä¸ç®¡lossæ˜¯å¦æ”¹å–„ï¼‰
checkpoint_manager.save_checkpoint(
    model=model,
    optimizer=optimizer,
    scheduler=scheduler,
    epoch=epoch,
    global_step=global_step,
    loss_history=train_losses,
    metrics={'avg_loss': avg_loss},
    tokenizer=tokenizer,
    config=config,
    is_best=(avg_loss < best_loss)
)
```

---

**æ€»ç»“**: å½“å‰ä»£ç çš„checkpointæœºåˆ¶å­˜åœ¨ä¸¥é‡ä¸è¶³ï¼Œå®¹æ˜“å¯¼è‡´é•¿æ—¶é—´è®­ç»ƒè¿›åº¦ä¸¢å¤±ã€‚å»ºè®®ç«‹å³å®æ–½æ–¹æ¡ˆAçš„å¿«é€Ÿä¿®å¤ï¼Œæœ€å¤šéœ€è¦1-2å°æ—¶å³å¯å¤§å¹…é™ä½é£é™©ã€‚
