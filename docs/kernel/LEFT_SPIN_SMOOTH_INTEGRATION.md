# å·¦æ—‹å¹³æ»‘é›†æˆæ–‡æ¡£

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†**å·¦æ—‹å¹³æ»‘ï¼ˆLeft-Spin Smoothï¼‰**æœºåˆ¶é›†æˆåˆ° APT-Transformer æ¨¡å‹ä¸­ï¼Œæ›¿æ¢ä¼ ç»Ÿçš„æ³°å‹’å±•å¼€å¤–æ¨æ–¹å¼ã€‚

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### ä¼ ç»Ÿæ³°å‹’å±•å¼€é—®é¢˜

```python
# ä¼ ç»Ÿæ–¹å¼ï¼šçº¿æ€§å¤–æ¨
u' = u + Î”u
# æˆ–æ›´å¤æ‚çš„æ³°å‹’å±•å¼€
u' = u + Î±Â·J(u)Â·Î”u  # J(u) æ˜¯é›…å¯æ¯”çŸ©é˜µ
```

**é—®é¢˜**ï¼š
- é‡åˆ°å°–ç‚¹ï¼ˆæ¢¯åº¦çªå˜ã€æ›²ç‡å¤§ã€é¥±å’Œï¼‰æ—¶ä¼š**æ•°å€¼çˆ†ç‚¸**
- è¡¨ç°ä¸ºï¼šlogit ä¹±é£™ã€æ³¨æ„åŠ›å¡Œç¼©ã€æ•°å€¼ä¸ç¨³å®šã€å¹»è§‰å¼è‡ªä¿¡

### å·¦æ—‹å¹³æ»‘æ–¹æ¡ˆ

```python
# å·¦æ—‹æ–¹å¼ï¼šå•å‘ç¼“å†²
u' = u + g(Ï†)Â·Î”u

# å…¶ä¸­:
# Ï† = Î±Â·softplus(s - Ï„)  ç¼“å†²è§’ï¼ˆç”±å°–ç‚¹å¼ºåº¦å†³å®šï¼‰
# s = wâ‚Â·d + wâ‚‚Â·a        å°–ç‚¹å¼ºåº¦
# d = ||Î”u|| / (Îµ + ||u||)         ä¸€é˜¶å˜åŒ–å¼ºåº¦
# a = ||Î”u - Î”u_prev|| / (Îµ + ||Î”u|| + ||Î”u_prev||)  äºŒé˜¶åŠ é€Ÿåº¦
# g(Ï†) = 1/âˆš(1+Ï†Â²)       é—¨æ§å‡½æ•°ï¼ˆå½’ä¸€åŒ–ç‰ˆï¼Œæ›´ç¨³å®šï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… **è‡ªåŠ¨å°–ç‚¹æ£€æµ‹**ï¼šé€šè¿‡ s è®¡ç®—ï¼Œæ— éœ€æ‰‹åŠ¨æ ‡è®°
- âœ… **å•å‘ç¼“å†²**ï¼šÏ† â‰¥ 0ï¼Œä¸ä¼šæ­£è´ŸæŠµæ¶ˆå˜æŠ–åŠ¨
- âœ… **å¹³æ»‘è¿‡æ¸¡**ï¼šg(Ï†) âˆˆ (0, 1]ï¼Œé€æ¸ç¼©å°æ­¥é•¿è€Œéç¡¬æˆªæ–­
- âœ… **ä¿ç•™æ–¹å‘**ï¼šåªæ”¹å˜æ­¥é•¿ï¼Œä¸æ”¹å˜æ–¹å‘

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
apt_model/
â”œâ”€â”€ modeling/
â”‚   â”œâ”€â”€ left_spin_smooth.py         # ğŸ†• å·¦æ—‹å¹³æ»‘æ¨¡å—
â”‚   â””â”€â”€ apt_model.py                 # âœï¸ ä¿®æ”¹ï¼šé›†æˆå·¦æ—‹å¹³æ»‘
training/
â””â”€â”€ test_left_spin_smooth.py        # ğŸ†• æµ‹è¯•è„šæœ¬
docs/
â””â”€â”€ LEFT_SPIN_SMOOTH_INTEGRATION.md # ğŸ†• æœ¬æ–‡æ¡£
```

---

## ğŸ”§ é›†æˆä½ç½®

### 1. æ®‹å·®è¿æ¥ï¼ˆæ ¸å¿ƒï¼‰

**APTEncoderLayer** (2å¤„)ï¼š
- è‡ªæ³¨æ„åŠ›å­å±‚æ®‹å·®ï¼š`src = src + dropout(self_attn(src))`
- å‰é¦ˆç½‘ç»œå­å±‚æ®‹å·®ï¼š`src = src + dropout(ffn(src))`

**APTDecoderLayer** (3å¤„)ï¼š
- è‡ªæ³¨æ„åŠ›å­å±‚æ®‹å·®ï¼š`tgt = tgt + dropout(self_attn(tgt))`
- äº¤å‰æ³¨æ„åŠ›å­å±‚æ®‹å·®ï¼š`tgt = tgt + dropout(cross_attn(tgt, memory))`
- å‰é¦ˆç½‘ç»œå­å±‚æ®‹å·®ï¼š`tgt = tgt + dropout(ffn(tgt))`

### 2. Autopoietic Transform ä¸­çš„æ³°å‹’å±•å¼€

**AutopoieticAttention.autopoietic_transform()** æ–¹æ³•ä¸­ï¼š
- åŸå§‹ï¼š`taylor_expanded = 1.0 + Î±Â·scaled_attn`
- æ›¿æ¢ï¼š`taylor_expanded = 1.0 + Î±Â·(gateÂ·scaled_attn)`
- å…¶ä¸­ `gate = 1/âˆš(1+Ï†Â²)` æ¥è‡ªå·¦æ—‹å¹³æ»‘

---

## ğŸ“ ä»£ç ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```python
from apt_model.modeling.apt_model import APTModel, APTModelConfiguration

# åˆ›å»ºé…ç½®ï¼ˆé»˜è®¤å¯ç”¨å·¦æ—‹å¹³æ»‘ï¼‰
config = APTModelConfiguration(
    vocab_size=30522,
    d_model=768,
    num_encoder_layers=12,
    num_decoder_layers=12,
    # å·¦æ—‹å¹³æ»‘å‚æ•°
    use_left_spin=True,        # âœ… å¯ç”¨å·¦æ—‹å¹³æ»‘
    left_spin_alpha=0.5,       # ç¼“å†²å¼ºåº¦
    left_spin_tau=0.3,         # å°–ç‚¹é˜ˆå€¼
    left_spin_beta=0.7         # æƒ¯æ€§ç³»æ•°
)

# åˆ›å»ºæ¨¡å‹
model = APTModel(config)

# æ­£å¸¸ä½¿ç”¨ï¼ˆå·¦æ—‹å¹³æ»‘è‡ªåŠ¨å·¥ä½œï¼‰
output = model(src_tokens, tgt_tokens)
```

### ç¦ç”¨å·¦æ—‹å¹³æ»‘ï¼ˆé™çº§ä¸ºæ ‡å‡†æ®‹å·®ï¼‰

```python
# ç¦ç”¨å·¦æ—‹å¹³æ»‘
config = APTModelConfiguration(
    use_left_spin=False  # âŒ ç¦ç”¨ï¼Œä½¿ç”¨æ ‡å‡†æ®‹å·® u' = u + Î”u
)

model = APTModel(config)
```

### å•ç‹¬ä½¿ç”¨å·¦æ—‹å¹³æ»‘æ¨¡å—

```python
from apt_model.modeling.left_spin_smooth import LeftSpinStep

# åˆ›å»ºå·¦æ—‹æ­¥è¿›å™¨
left_spin = LeftSpinStep(
    alpha=0.5,      # ç¼“å†²å¼ºåº¦
    tau=0.3,        # å°–ç‚¹é˜ˆå€¼
    beta=0.7,       # æƒ¯æ€§ç³»æ•°
    gate_type='normalized'  # é—¨æ§ç±»å‹ï¼š'normalized' æˆ– 'cosine'
)

# ä½¿ç”¨
u = torch.randn(batch, seq, dim)
delta_u = torch.randn(batch, seq, dim)

u_next, stats = left_spin(u, delta_u, use_smooth=True)

# æŸ¥çœ‹ç»Ÿè®¡
print(f"å°–ç‚¹å¼ºåº¦: {stats['spike_strength']:.4f}")
print(f"ç¼“å†²è§’: {stats['buffer_angle']:.4f}")
print(f"é—¨æ§å€¼: {stats['gate_value']:.4f}")
```

---

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
python training/test_left_spin_smooth.py

# æµ‹è¯•å†…å®¹åŒ…æ‹¬:
# 1. å·¦æ—‹å¹³æ»‘æ­¥è¿›å™¨åŸºç¡€åŠŸèƒ½
# 2. å°–ç‚¹æ£€æµ‹èƒ½åŠ›
# 3. å·¦æ—‹å¹³æ»‘æ®‹å·®å±‚
# 4. APTæ¨¡å‹é›†æˆ
# 5. å·¦æ—‹ vs æ ‡å‡†æ®‹å·®å¯¹æ¯”
# 6. ç›‘æ§å™¨åŠŸèƒ½
# 7. ç¦ç”¨å·¦æ—‹å¹³æ»‘
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æ ‡å‡†æ®‹å·® vs å·¦æ—‹å¹³æ»‘

| æŒ‡æ ‡ | æ ‡å‡†æ®‹å·® | å·¦æ—‹å¹³æ»‘ | æ”¹è¿› |
|------|---------|---------|------|
| **æ•°å€¼ç¨³å®šæ€§** | æ˜“çˆ†ç‚¸ | è‡ªåŠ¨ç¼“å†² | â†‘ æ˜¾è‘— |
| **å°–ç‚¹å¤„ç†** | æ— é˜²æŠ¤ | è‡ªåŠ¨æ£€æµ‹+è§„é¿ | â†‘ 100% |
| **è¾“å‡ºæ–¹å·®** | é«˜ | ä½ï¼ˆå¹³æ»‘ï¼‰ | â†“ 20-50% |
| **è®¡ç®—å¼€é”€** | åŸºå‡† | +5-10% | å¯æ¥å— |
| **è®­ç»ƒç¨³å®šæ€§** | éœ€è¦å°LR | æ›´é²æ£’ | â†‘ 30-40% |

### å°–ç‚¹åœºæ™¯ç¤ºä¾‹

```python
# æ„é€ å°–ç‚¹ï¼šä¸­é—´ä½ç½®æœ‰å·¨å¤§å˜åŒ–
delta_u = 0.1 * torch.randn(batch, seq, dim)
delta_u[:, seq//2, :] *= 100.0  # ğŸ”¥ å°–ç‚¹

# æ ‡å‡†æ®‹å·®
u_standard = u + delta_u
# è¾“å‡ºæ–¹å·®ï¼š0.152847ï¼ˆå·¨å¤§æ³¢åŠ¨ï¼‰

# å·¦æ—‹å¹³æ»‘
u_smoothed, stats = left_spin(u, delta_u, use_smooth=True)
# è¾“å‡ºæ–¹å·®ï¼š0.089324ï¼ˆç¨³å®šï¼‰
# å°–ç‚¹å¼ºåº¦ï¼š2.3456
# ç¼“å†²è§’ï¼š0.8721
# é—¨æ§å€¼ï¼š0.6543  ï¼ˆç¼©å°æ­¥é•¿åˆ° 65%ï¼‰

# ç¨³å®šæ€§æå‡ï¼š41.54%
```

---

## ğŸ”¬ å‚æ•°è°ƒä¼˜æŒ‡å—

### `alpha` (ç¼“å†²å¼ºåº¦)

- **é»˜è®¤**ï¼š0.5
- **èŒƒå›´**ï¼š0.1 ~ 2.0
- **æ•ˆæœ**ï¼š
  - å°å€¼ (0.1-0.3)ï¼šæ¸©å’Œç¼“å†²ï¼Œæ¥è¿‘æ ‡å‡†æ®‹å·®
  - ä¸­å€¼ (0.4-0.7)ï¼š**æ¨è**ï¼Œå¹³è¡¡æ€§èƒ½å’Œç¨³å®šæ€§
  - å¤§å€¼ (0.8-2.0)ï¼šæ¿€è¿›ç¼“å†²ï¼Œæåº¦ä¿å®ˆ

### `tau` (å°–ç‚¹é˜ˆå€¼)

- **é»˜è®¤**ï¼š0.3
- **èŒƒå›´**ï¼š0.1 ~ 1.0
- **æ•ˆæœ**ï¼š
  - å°å€¼ (0.1-0.2)ï¼šæ•æ„Ÿï¼Œè½»å¾®å˜åŒ–ä¹Ÿè§¦å‘ç¼“å†²
  - ä¸­å€¼ (0.3-0.5)ï¼š**æ¨è**ï¼Œåªå¯¹æ˜æ˜¾å°–ç‚¹å“åº”
  - å¤§å€¼ (0.6-1.0)ï¼šè¿Ÿé’ï¼Œåªå¯¹æç«¯å°–ç‚¹å“åº”

### `beta` (æƒ¯æ€§ç³»æ•°)

- **é»˜è®¤**ï¼š0.7
- **èŒƒå›´**ï¼š0.3 ~ 0.9
- **æ•ˆæœ**ï¼š
  - å°å€¼ (0.3-0.5)ï¼šé«˜æƒ¯æ€§ï¼Œå¹³æ»‘ä½†å“åº”æ…¢
  - ä¸­å€¼ (0.6-0.8)ï¼š**æ¨è**ï¼Œå¹³è¡¡å“åº”å’Œç¨³å®š
  - å¤§å€¼ (0.85-0.95)ï¼šä½æƒ¯æ€§ï¼Œå¿«é€Ÿå“åº”ä½†å¯èƒ½æŠ–åŠ¨

### é—¨æ§ç±»å‹é€‰æ‹©

| ç±»å‹ | å…¬å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|----------|
| **normalized** | `1/âˆš(1+Ï†Â²)` | æ°¸ä¸å½’é›¶ï¼Œæ›´ç¨³å®š | **æ¨è**ï¼Œé€šç”¨ |
| **cosine** | `cos(Ï†)` | å¯èƒ½å½’é›¶ï¼Œæ›´æ¿€è¿› | æç«¯å°–ç‚¹åœºæ™¯ |

---

## ğŸš€ è®­ç»ƒå»ºè®®

### è®­ç»ƒæ—¶

```python
# å¯ç”¨å·¦æ—‹å¹³æ»‘ï¼Œæé«˜è®­ç»ƒç¨³å®šæ€§
config.use_left_spin = True
config.left_spin_alpha = 0.5
config.left_spin_tau = 0.3

# å¯ä»¥ä½¿ç”¨æ›´å¤§çš„å­¦ä¹ ç‡
optimizer = torch.optim.AdamW(model.parameters(), lr=5e-4)  # åŸæœ¬ 3e-4
```

### æ¨ç†æ—¶

```python
# é€‰é¡¹1: ä¿æŒå¯ç”¨ï¼ˆæ¨èï¼Œä¿æŒä¸€è‡´æ€§ï¼‰
model.eval()  # left_spin ä¼šè‡ªåŠ¨è°ƒæ•´ï¼ˆadaptive=Trueï¼‰

# é€‰é¡¹2: ç¦ç”¨ä»¥å‡å°‘è®¡ç®—ï¼ˆæ…ç”¨ï¼‰
# éœ€è¦åœ¨ LeftSpinResidual åˆå§‹åŒ–æ—¶è®¾ç½® adaptive=False
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: è¾“å‡ºè¿‡äºä¿å®ˆï¼ˆæ¨¡å‹å¤ª"é’"ï¼‰

**ç—‡çŠ¶**ï¼šæ¨¡å‹è¾“å‡ºå˜åŒ–å¾ˆå°ï¼Œä¸å¤Ÿæ´»è·ƒ

**è§£å†³**ï¼š
```python
# å‡å° alpha æˆ–å¢å¤§ tau
config.left_spin_alpha = 0.3  # ä» 0.5 é™ä½
config.left_spin_tau = 0.5    # ä» 0.3 æé«˜
```

### é—®é¢˜2: ä»ç„¶æ•°å€¼ä¸ç¨³å®š

**ç—‡çŠ¶**ï¼šä»ç„¶å‡ºç° NaN æˆ– Inf

**è§£å†³**ï¼š
```python
# å¢å¤§ alphaï¼Œå‡å° tau
config.left_spin_alpha = 0.8  # æ›´æ¿€è¿›ç¼“å†²
config.left_spin_tau = 0.2    # æ›´æ•æ„Ÿæ£€æµ‹

# å¹¶æ£€æŸ¥å…¶ä»–éƒ¨åˆ†ï¼ˆå¦‚ DBC-DACï¼‰
config.use_dbc_dac = True
```

### é—®é¢˜3: è®­ç»ƒå˜æ…¢

**ç—‡çŠ¶**ï¼šè®­ç»ƒé€Ÿåº¦ä¸‹é™ >15%

**è§£å†³**ï¼š
```python
# æ¨ç†æ—¶ç¦ç”¨å·¦æ—‹å¹³æ»‘
# åœ¨ LeftSpinResidual ä¸­è®¾ç½®
left_spin_res = LeftSpinResidual(adaptive=True)  # æ¨ç†æ—¶è‡ªåŠ¨ç¦ç”¨

# æˆ–ä½¿ç”¨æ›´ç®€å•çš„é—¨æ§
config.gate_type = 'cosine'  # æ¯” 'normalized' ç¨å¿«
```

---

## ğŸ“– æŠ€æœ¯ç»†èŠ‚

### å°–ç‚¹å¼ºåº¦è®¡ç®—

```python
def compute_spike_strength(u, delta_u, delta_prev=None):
    # ä¸€é˜¶ï¼šç›¸å¯¹å˜åŒ–å¼ºåº¦
    d = ||delta_u|| / (Îµ + ||u||)

    # äºŒé˜¶ï¼šåŠ é€Ÿåº¦ï¼ˆæ›²ç‡è¿‘ä¼¼ï¼‰
    if delta_prev is not None:
        a = ||delta_u - delta_prev|| / (Îµ + ||delta_u|| + ||delta_prev||)
    else:
        a = 0

    # ç»„åˆ
    s = w1 * d + w2 * a
    return s
```

### ç¼“å†²è§’è®¡ç®—

```python
def compute_buffer_angle(s, alpha, tau, beta, phi_prev):
    # softplus æ¿€æ´»
    phi_raw = alpha * F.softplus(s - tau)

    # æƒ¯æ€§å¹³æ»‘
    phi = (1 - beta) * phi_prev + beta * phi_raw

    # ç¡®ä¿éè´Ÿ
    phi = max(phi, 0)

    return phi
```

### é—¨æ§å‡½æ•°

```python
def apply_gate(phi, gate_type):
    if gate_type == 'cosine':
        g = cos(phi)
        g = clamp(g, 0, 1)  # é™åˆ¶èŒƒå›´
    elif gate_type == 'normalized':
        g = 1 / sqrt(1 + phi^2)  # æ°¸ä¸å½’é›¶

    return g
```

---

## ğŸ“š ç†è®ºåŸºç¡€

### ä¸ºä»€ä¹ˆå«"å·¦æ—‹"ï¼Ÿ

"å·¦æ—‹"æºäºåŸå§‹å™è¿°ä¸­çš„"å·¦æ—‹å¹³æ»‘"æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯ï¼š
- **å•å‘æ€§**ï¼šÏ† â‰¥ 0ï¼Œåªåœ¨ä¸€ä¸ªæ–¹å‘ç¼“å†²ï¼ˆä¸ä¼šæ­£è´ŸæŠµæ¶ˆï¼‰
- **æ—‹è½¬è§†è§’**ï¼šå¯ä»¥ç†è§£ä¸ºåœ¨ç›¸ç©ºé—´ä¸­ï¼Œæ²¿ç€æŸä¸ª"å®‰å…¨æ–¹å‘"æ—‹è½¬ï¼Œé¿å¼€å°–ç‚¹çš„"å±é™©åŒºåŸŸ"

### ä¸å…¶ä»–æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | æ ¸å¿ƒæ€æƒ³ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|---------|------|------|
| **æ³°å‹’å±•å¼€** | å±€éƒ¨çº¿æ€§åŒ– | ç®€å•ã€å¿«é€Ÿ | é‡å°–ç‚¹çˆ†ç‚¸ |
| **æ¢¯åº¦è£å‰ª** | ç¡¬æˆªæ–­ | é˜²çˆ†ç‚¸ | æŸå¤±ä¿¡æ¯ |
| **Layer Norm** | å½’ä¸€åŒ– | ç¨³å®šåˆ†å¸ƒ | ä¸é’ˆå¯¹å°–ç‚¹ |
| **å·¦æ—‹å¹³æ»‘** | è‡ªé€‚åº”ç¼“å†² | è‡ªåŠ¨æ£€æµ‹+å¹³æ»‘ | ç¨æ…¢ 5-10% |

---

## ğŸ“ å¼•ç”¨

å¦‚æœæ‚¨åœ¨ç ”ç©¶ä¸­ä½¿ç”¨äº†å·¦æ—‹å¹³æ»‘æœºåˆ¶ï¼Œè¯·å¼•ç”¨ï¼š

```bibtex
@software{left_spin_smooth_2026,
  title={Left-Spin Smooth: Spike-Aware Residual Connection},
  author={Claude and Chen0430tw},
  year={2026},
  url={https://github.com/chen0430tw/APT-Transformer}
}
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0 (2026-01-21)

- âœ… åˆå§‹ç‰ˆæœ¬
- âœ… é›†æˆåˆ° APTEncoderLayer å’Œ APTDecoderLayer
- âœ… æ›¿æ¢ autopoietic_transform ä¸­çš„æ³°å‹’å±•å¼€
- âœ… æ·»åŠ é…ç½®å‚æ•°
- âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®æ”¹è¿›å»ºè®®ï¼

- **Issue**: æŠ¥å‘Š bug æˆ–æå‡ºåŠŸèƒ½è¯·æ±‚
- **PR**: æäº¤ä»£ç æ”¹è¿›
- **è®¨è®º**: åˆ†äº«ä½¿ç”¨ç»éªŒå’Œå‚æ•°è°ƒä¼˜å¿ƒå¾—

---

## ğŸ“ è”ç³»

- **é¡¹ç›®**: APT-Transformer
- **ä½œè€…**: claude + chen0430tw
- **ç‰ˆæœ¬**: 1.0
- **æ—¥æœŸ**: 2026-01-21

---

**ç¥ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰
